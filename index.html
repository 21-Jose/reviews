<script>
  // ... resto del script intacto ...

  function loadMoreComments(count = 1) {
    const container = document.getElementById('comments-container');
    for (let i = 0; i < count && currentIndex < filteredComments.length; i++) {
      const { user, rating, text, translated } = filteredComments[currentIndex++];
      const isRayo = user.toLowerCase().includes("rayo");
      const div = document.createElement('div');
      div.className = 'comment';
      div.innerHTML = `
        <div class="stars">${renderStars(rating, isRayo)}</div>
        <div class="username hidden-name">
          <button class="reveal-name-btn" title="Mostrar nombre">❔</button>
          <span class="name-text">${user}</span>
        </div>
        <div class="text">${text}</div>
        ${translated ? `
          <button class="translate-btn">Mostrar traducción</button>
          <div class="translated-text">${translated}</div>
        ` : ''}
      `;
      container.appendChild(div);
      requestAnimationFrame(() => div.classList.add('show'));
    }
  }

  function loadUntilFilled() {
    loadMoreComments(1);
    requestAnimationFrame(() => {
      if (
        document.body.scrollHeight <= window.innerHeight &&
        currentIndex < filteredComments.length
      ) {
        loadUntilFilled();
      }
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    applyFilters();

    // Extra seguridad: vuelve a intentar llenar si fue insuficiente
    setTimeout(() => {
      if (document.body.scrollHeight <= window.innerHeight && currentIndex < filteredComments.length) {
        loadUntilFilled();
      }
    }, 500);

    document.getElementById('search-input').addEventListener('input', applyFilters);
    document.getElementById('sort-select').addEventListener('change', applyFilters);

    const toggleNamesBtn = document.getElementById('toggle-names-btn');
    let namesVisible = false;

    toggleNamesBtn.addEventListener('click', () => {
      const usernames = document.querySelectorAll('.username');
      usernames.forEach(u => {
        u.classList.toggle('visible-name', !namesVisible);
        u.classList.toggle('hidden-name', namesVisible);
      });
      namesVisible = !namesVisible;
      toggleNamesBtn.textContent = namesVisible
        ? "Ocultar nombres de usuarios"
        : "Mostrar nombres de usuarios";
    });

    const container = document.getElementById('comments-container');
    container.addEventListener('click', (e) => {
      if (e.target.classList.contains("translate-btn")) {
        e.stopPropagation();
        const btn = e.target;
        const txt = btn.nextElementSibling;
        const isVisible = txt.classList.contains('show');
        txt.classList.toggle('show');
        btn.textContent = isVisible ? "Mostrar traducción" : "Ocultar traducción";
      }

      if (e.target.classList.contains("reveal-name-btn")) {
        e.stopPropagation();
        const comment = e.target.closest('.comment');
        const nameEl = comment.querySelector(".username");
        nameEl.classList.remove('hidden-name');
        nameEl.classList.add('visible-name');
      }
    });
  });

  window.addEventListener('scroll', () => {
    if (
      window.innerHeight + window.scrollY >= document.body.offsetHeight - 100 &&
      currentIndex < filteredComments.length
    ) {
      loadMoreComments(1);
    }
  });
</script>
